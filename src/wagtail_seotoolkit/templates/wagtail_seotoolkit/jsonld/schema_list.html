{% extends "wagtailadmin/base.html" %}
{% load i18n static %}

{% block titletag %}
    {% trans "JSON-LD Schema Templates" %} - {% trans "SEO Toolkit" %}
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'wagtail_seotoolkit/css/seo_issues_report.css' %}">
    <link rel="stylesheet" href="{% static 'wagtail_seotoolkit/css/subscription_banner.css' %}">
    <link rel="stylesheet" href="{% static 'wagtail_seotoolkit/css/email_verification.css' %}">
    <link rel="stylesheet" href="{% static 'wagtail_seotoolkit/css/jsonld_editor.css' %}">
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
        window.django = window.django || {};
        window.django.subscriptionContext = {
            email: {% if subscription_email %}"{{ subscription_email }}"{% else %}null{% endif %},
            instanceId: {% if subscription_instance_id %}"{{ subscription_instance_id }}"{% else %}null{% endif %}
        };
    </script>
    <script src="{% static 'wagtail_seotoolkit/js/subscription_status.js' %}"></script>
    <script src="{% static 'wagtail_seotoolkit/js/subscription_gate.js' %}"></script>
    <script src="{% static 'wagtail_seotoolkit/js/jsonld_list.js' %}"></script>
{% endblock %}

{% block content %}
    <div id="message-container"></div>
    
    <!-- CSRF Token for AJAX requests -->
    {% csrf_token %}
    
    <!-- Subscription Gate -->
    <div id="subscription-gate-jsonld-editor">
        <!-- Email Verification Required Banner (Matches SEO Dashboard style) -->
        <div id="no-email-banner" class="email-verification-overlay" style="display: none;">
            <div class="email-verification-card">
                <div class="email-verification-header">
                    <svg class="email-verification-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <h2 class="email-verification-title">JSON-LD Editor - Pro Feature</h2>
                    <p class="email-verification-subtitle">
                        The JSON-LD Editor requires email verification and an active Pro subscription
                    </p>
                </div>
                
                <div class="email-verification-benefits">
                    <p class="email-verification-benefits-title">Required to access:</p>
                    <ul class="email-verification-benefits-list">
                        <li>✓ Verified email address</li>
                        <li>✓ Active Pro subscription</li>
                    </ul>
                </div>
                
                <div class="email-verification-text">
                    <p>To get started:</p>
                    <ol style="text-align: left; padding-left: 1.5rem; margin: 0.5rem 0;">
                        <li>Verify your email in the <strong>SEO Dashboard</strong></li>
                        <li>Purchase a Pro subscription in <strong>Subscription Settings</strong></li>
                    </ol>
                </div>
                
                <a href="/admin/seo-dashboard/" class="email-verification-button">
                    Go to SEO Dashboard to Verify Email
                </a>
            </div>
        </div>

        <!-- Upgrade Banner -->
        <div id="upgrade-banner" class="email-verification-overlay" style="display: none;">
            <div class="email-verification-card">
                <div class="email-verification-header">
                    <svg class="email-verification-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <h2 class="email-verification-title">Upgrade to Pro</h2>
                    <p class="email-verification-subtitle">
                        The JSON-LD Editor is a premium feature. Upgrade to enhance your search results with structured data.
                    </p>
                </div>
                
                <div id="plans-display-container" class="plans-display">
                    <div class="loading-spinner">
                        <p>Loading plans...</p>
                    </div>
                </div>

                <div class="email-verification-text" style="text-align: center; margin-top: 1.5rem;">
                    <p>Already have a subscription? <a href="/admin/settings/subscription-settings/">Manage Subscription</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Protected Content -->
    <div id="jsonld-editor-protected-content" style="display: none;">
        <header class="w-header">
            <div class="row">
                <div class="left">
                    <div class="col">
                        <h1 class="w-header__title">
                            <svg class="icon icon-code w-header__glyph" aria-hidden="true"><use href="#icon-code"></use></svg>
                            {% trans "JSON-LD Schema Templates" %}
                        </h1>
                    </div>
                </div>
                <div class="right">
                    <a href="{% url 'jsonld_schema_create' %}" class="button">
                        {% trans "Create Template" %}
                    </a>
                    <a href="{% url 'jsonld_site_wide' %}" class="button button-secondary">
                        {% trans "Site-Wide Schemas" %}
                    </a>
                </div>
            </div>
        </header>

        <div class="nice-padding">
            {% if templates %}
                <h2>{% trans "Page-Type Templates" %}</h2>
                <p class="help-info" style="margin-bottom: 1rem;">
                    {% trans "Each page type can have one JSON-LD template. Add schema types (BlogPosting, Article, etc.) within each template." %}
                </p>
                <table class="listing">
                    <thead>
                        <tr>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Page Type" %}</th>
                            <th>{% trans "Schemas" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th>{% trans "Created" %}</th>
                            <th>{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for template in templates %}
                            <tr data-template-id="{{ template.id }}">
                                <td class="title">
                                    <strong>{{ template.name }}</strong>
                                </td>
                                <td>
                                    {% if template.content_type %}
                                        <span class="badge">{{ template.content_type.name }}</span>
                                    {% else %}
                                        <span class="badge badge-secondary">{% trans "Default (All Pages)" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if template.schemas %}
                                        {% for block in template.schemas %}
                                            <span class="badge badge-outline">{{ block.block_type|title }}</span>
                                        {% empty %}
                                            <span class="muted">{% trans "No schemas" %}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="muted">{% trans "No schemas" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if template.is_active %}
                                        <span class="status-tag primary">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="status-tag">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ template.created_at|date:"M d, Y" }}
                                    {% if template.created_by %}
                                        <br><small class="muted">by {{ template.created_by.get_full_name|default:template.created_by.username }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="actions">
                                        <span><a href="{% url 'jsonld_schema_edit' template.id %}" class="button button-small button-secondary">
                                            {% trans "Edit" %}
                                        </a></span>
                                        <span><button type="button" 
                                                class="button button-small button-secondary delete-template" 
                                                data-template-id="{{ template.id }}" 
                                                data-template-name="{{ template.name }}">
                                            {% trans "Delete" %}
                                        </button></span>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="nice-padding">
                    <p class="help-info">
                        {% trans "No JSON-LD schema templates found. Create your first template to get started!" %}
                    </p>
                    <a href="{% url 'jsonld_schema_create' %}" class="button">
                        {% trans "Create Your First Template" %}
                    </a>
                </div>
            {% endif %}

        </div>
    </div>
{% endblock %}
